@model EventTickets.Models.Purchase
@{
    var eventsList = ViewBag.Events as List<EventTickets.Models.Event> ?? new();
    ViewData["Title"] = "Guest Ticket Purchase";
}
<h1>Guest Ticket Purchase</h1>
<div asp-validation-summary="All" class="text-danger" style="margin:.5rem 0;"></div>

<form asp-action="Create" method="post" id="purchaseForm">
  <div>
    <label asp-for="EventId">Event</label>
    <select asp-for="EventId" id="eventSelect">
      <option value="">-- Select an event --</option>
      @foreach (var e in eventsList)
      {
          var soldOut = e.AvailableTickets <= 0;
          <option value="@e.Id"
                  disabled="@(soldOut)"
                  data-price="@e.Price"
                  data-available="@e.AvailableTickets">
              @e.Title (@(e.DateTime?.ToString("yyyy-MM-dd") ?? "-"))
              @(soldOut ? " — SOLD OUT" : $" — {e.AvailableTickets} left")
              — $@e.Price
          </option>
      }
    </select>
    <span class="muted">Sold out events are disabled.</span>
  </div>

  <div>
      <label asp-for="Quantity"></label>
      <input asp-for="Quantity" id="quantityInput" />
      <span asp-validation-for="Quantity" class="text-danger"></span>
  </div>

  <div>
      <label asp-for="CustomerName"></label>
      <input asp-for="CustomerName" />
      <span asp-validation-for="CustomerName" class="text-danger"></span>
  </div>

  <div>
      <label asp-for="Email"></label>
      <input asp-for="Email" />
      <span asp-validation-for="Email" class="text-danger"></span>
  </div>

  <div class="card" style="margin:1rem 0; padding:.5rem 1rem;">
      <strong>Cart:</strong>
      <span id="cartBadge" class="badge">0 ticket(s)</span>
      <span style="margin-left:1rem;">Total: $<span id="cartTotal">0.00</span></span>
      <p id="stockWarning" class="text-danger" style="margin-top:.5rem; display:none;"></p>
  </div>

  <button class="btn" type="submit">Continue</button>
  <a class="btn btn-outline" asp-controller="Home" asp-action="Index">Cancel</a>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            const eventSelect = document.getElementById('eventSelect');
            const quantityInput = document.getElementById('quantityInput');
            const cartBadge = document.getElementById('cartBadge');
            const cartTotal = document.getElementById('cartTotal');
            const stockWarning = document.getElementById('stockWarning');

            function parseDecimal(value) {
                const n = parseFloat(value);
                return isNaN(n) ? 0 : n;
            }

            function parseIntSafe(value) {
                const n = parseInt(value);
                return isNaN(n) ? 0 : n;
            }

            function updateCart() {
                if (!eventSelect || !quantityInput) return;

                const selected = eventSelect.options[eventSelect.selectedIndex];
                const qty = parseIntSafe(quantityInput.value);
                const safeQty = qty > 0 ? qty : 0;

                if (!selected || !selected.value) {
                    cartBadge.textContent = safeQty + " ticket(s)";
                    cartTotal.textContent = "0.00";
                    stockWarning.style.display = "none";
                    return;
                }

                const price = parseDecimal(selected.getAttribute("data-price"));
                const available = parseIntSafe(selected.getAttribute("data-available"));

                cartBadge.textContent = safeQty + " ticket(s)";
                const total = price * safeQty;
                cartTotal.textContent = total.toFixed(2);

                if (available > 0 && available <= 7) {
                    stockWarning.textContent = "Hurry! Only " + available + " tickets left!";
                    stockWarning.style.display = "block";
                } else {
                    stockWarning.style.display = "none";
                }
            }

            if (eventSelect && quantityInput) {
                eventSelect.addEventListener("change", updateCart);
                quantityInput.addEventListener("input", updateCart);
                updateCart();
            }
        })();
    </script>
}
